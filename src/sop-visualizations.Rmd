---
title: 'Assessing the State of Practice of addressing Threats to Validity in Crossover-Design Experiments: Visualizations'
author: "Anonymous Author"
date: '2024-05-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
```

This notebook visualizes the results from the data extraction phase of the study investigating the state of practice of addressing threats to validity in crossover-design experiments at analysis time.

## Data

```{r data-loading}
data <- read_excel("../data/state-of-practice/data-extraction.xlsx", sheet="Extraction", skip=2)

head(data)
```

Rename all columns where R does not parse the column name directly (i.e., replace dashes by dots).

```{r data-renaming}
data <- data %>% 
  rename(all_of(c(
    subject.number = "Subject-Number",
    subject.type = "Subject-Type",

    method = "Method",
    test.type = "Test Type",
    
    availability.data = "Data-Availability",
    availability.analysis = "Analysis-Availability"
    )))
```

Cast data to its appropriate type

```{r data-casting}
cat.subjects <- c("Students", "Student Groups", "Practitioners", "Pracititioner Groups", "Both", "Mixed Groups", "Researchers", "Unknown", "Other")
cat.threats <- c("Period", "Sequence", "Skill", "Carryover")
cat.method <- c("NHST", "GLM", "GLMM", "GEE", "Other", "Unknown")
cat.type <- c("Unpaired T", "Paired T", "Mann-Whitney U", "Wilcoxon signed-rank", "ANOVA", "Kruskal-Wallis", "Other")
cat.addressal <- c("Modeled", "Stratified", "Isolated", "Acknowledged", "Neglected", "Ignored")
cat.availability <- c("Proprietary", "Private", "Unavailable", "Broken", "Upon Request", "Reachable", "Open Source", "Archived")


data <- data %>% 
  mutate(
    subject.type <- factor(subject.type, levels=cat.subjects, ordered=FALSE),
    subject.number = as.integer(subject.number),
    
    method <- factor(method, levels=cat.method, ordered=FALSE),
    test.type <- factor(test.type, levels=cat.type, ordered=FALSE),
    
    Period <- factor(Period, levels=cat.addressal, ordered=TRUE),
    Sequence <- factor(Sequence, levels=cat.addressal, ordered=TRUE),
    Skill <- factor(Skill, levels=cat.addressal, ordered=TRUE),
    Carryover <- factor(Carryover, levels=cat.addressal, ordered=TRUE),
    
    availability.data <- factor(availability.data, levels=cat.availability, ordered=TRUE),
    availability.analysis <- factor(availability.analysis, levels=cat.availability, ordered=TRUE),
  )
```

## Subjects

The first group of attributes describes the subjects involved in the investigated experiments.
The subject type describes the type of participants included in the experiment.

```{r vis-subject-type}
n.per.subject.type <- data %>% 
  group_by(subject.type) %>% 
  tally() %>% 
  mutate(
    label.vjust = ifelse(n<3, -0.8, 1.5),
    label.color = ifelse(n<3, "black", "white")
    )
  
n.per.subject.type %>% 
  ggplot(aes(x=factor(subject.type, level=cat.subjects), y=n)) +
    geom_bar(stat="identity") +
    geom_text(aes(label=n), vjust=n.per.subject.type$label.vjust, color=n.per.subject.type$label.color) +
    labs(x = "Subject Type", y = "Count") +
    theme(axis.text.x = element_text(angle=10))

ggsave(file='../figures/subject-type.pdf', device = "pdf",
       width = 14, height = 8, units = "cm")
```

The subject count visualizes the number of participants involved in the experiment.

```{r vis-subject-count}
ggplot(data, aes(x=subject.number)) +
  geom_boxplot(notch=TRUE, notchwidth=0.3, na.rm=TRUE) +
  labs(x="Number of Participants") +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank())

ggsave(file='../figures/subject-count.pdf', device = "pdf",
       width = 14, height = 3, units = "cm")
```

```{r stat-subject-count}
median(data$subject.number, na.rm=TRUE)
mean(data$subject.number, na.rm=TRUE)
```


## Analysis

The attribute group *Analysis* contains all attributes that characterize how the sample of primary studies analyzed the data obtained from their experiments.
The method represents the type of statistical test performed by the authors.


```{r vis-method}
n.per.method <- data %>%
  group_by(method) %>%
  tally() %>%
  mutate(
    label.vjust = ifelse(n<3, -0.8, 1.5),
    label.color = ifelse(n<3, "black", "white")
    )

n.per.method %>%
  ggplot(aes(x=factor(method, level=cat.method), y=n)) +
    geom_bar(stat="identity") +
    geom_text(aes(label=n), vjust=n.per.method$label.vjust, color=n.per.method$label.color) +
    labs(x = "Subject Type", y = "Count") +
    theme(
      axis.text.x = element_text(angle=0), 
      panel.grid.minor.y = element_blank()
    )

ggsave(file='../figures/method.pdf', device = "pdf",
       width = 14, height = 5, units = "cm")
```

The test type applies only to experiments that were analyzed using a null-hypothesis significance test (`method=NHST`).
It represents the test type in implies the assumptions of the authors.

```{r vis-test-type}
n.per.test <- data %>%
  group_by(test.type) %>%
  tally() %>%
  mutate(
    label.vjust = ifelse(n<3, -0.8, 1.5),
    label.color = ifelse(n<3, "black", "white")
    ) %>% 
  filter(test.type != "NA")

n.per.test %>%
  ggplot(aes(x=factor(test.type, level=cat.type), y=n)) +
    geom_bar(stat="identity") +
    geom_text(aes(label=n), vjust=n.per.test$label.vjust, color=n.per.test$label.color) +
    labs(x = "Subject Type", y = "Count") +
    theme(
      axis.text.x = element_text(angle=10), 
      panel.grid.minor.y = element_blank()
    )

ggsave(file='../figures/test-type.pdf', device = "pdf",
       width = 14, height = 7, units = "cm")
```

The *addressal* attribute represents how the analyses addressed the threats to validity inherent to the crossover design.

```{r vis-addressal}
d.pivot <- data %>% 
  select(cat.threats) %>% 
  pivot_longer(cols = everything(), names_to = "threat", values_to = "addressal") %>% 
  count(threat, addressal) %>% 
  mutate(label.color = ifelse(n < 30, "white", "black"))

d.pivot %>% 
  ggplot(aes(
    factor(threat, levels=cat.threats),
    factor(addressal, levels=cat.addressal))
  ) +
    geom_tile(aes(fill=n)) +
    geom_text(aes(label=n), color=d.pivot$label.color) +
    labs(x = "Threats to Validity", y = "Types of Addressal", fill = "Count")

ggsave(file='../figures/addressal.pdf', device = "pdf",
       width = 14, height = 9, units = "cm")
```

Perfect addressal is when all four threats to validity are `modeled`.

```{r perfect-addressal}
data %>% 
  filter(
    Period == 'Modeled', 
    Sequence == 'Modeled', 
    Skill == 'Modeled', 
    Carryover == 'Modeled', 
  )
```


## Material

The material attributes represent how available the material (data and analysis scripts) are.

```{r vis-availability-data}
n.per.category <- data %>%
  group_by(availability.data) %>%
  tally() %>%
  mutate(
    label.vjust = ifelse(n<3, -0.8, 1.5),
    label.color = ifelse(n<3, "black", "white")
    )

n.per.category %>%
  ggplot(aes(x=factor(availability.data, level=cat.availability), y=n)) +
    geom_bar(stat="identity") +
    geom_text(aes(label=n), vjust=n.per.category$label.vjust, color=n.per.category$label.color) +
    labs(x = "Subject Type", y = "Count") +
    theme(
      axis.text.x = element_text(angle=0), 
      panel.grid.minor.y = element_blank()
    )

ggsave(file='../figures/availability-data.pdf', device = "pdf",
        width = 14, height = 6, units = "cm")
```

```{r vis-availability-analysis}
n.per.category <- data %>%
  group_by(availability.analysis) %>%
  tally() %>%
  mutate(
    label.vjust = ifelse(n<3, -0.8, 1.5),
    label.color = ifelse(n<3, "black", "white")
    )

n.per.category %>%
  ggplot(aes(x=factor(availability.analysis, level=cat.availability), y=n)) +
    geom_bar(stat="identity") +
    geom_text(aes(label=n), vjust=n.per.category$label.vjust, color=n.per.category$label.color) +
    labs(x = "Subject Type", y = "Count") +
    theme(
      axis.text.x = element_text(angle=0), 
      panel.grid.minor.y = element_blank()
    )

ggsave(file='../figures/availability-analysis.pdf', device = "pdf",
        width = 14, height = 6, units = "cm")
```
